/**
 * This file is part of the Mesour Selection (http://grid.mesour.com)
 *
 * Copyright (c) 2015 Matouš Němec (http://mesour.com)
 *
 * For full licence and copyright please view the file licence.md in root of this project
 */
var mesour=!mesour?{}:mesour;mesour.selection=!mesour.selection?{}:mesour.selection;(function($){var k=function(a,b){if(a.hasClass('btn-default')){l(a,b)}else{m(a,b)}};var l=function(a,b,c){c=!c?mesour.selection.ICON_CHECKED:c;a.removeClass(b.inactiveClass).addClass(b.activeClass);a.html('<span class="'+b['iconPrefix']+mesour.selection.getIcon(c)+'"></span>')};var m=function(a,b){a.addClass(b.inactiveClass).removeClass(b.activeClass);a.html('&nbsp;&nbsp;&nbsp;&nbsp;')};var n=function(c,d,f){var g=c.attr(f.nameAttr),mainCheckbox=$(f.mainSelector).filter('['+f.nameAttr+'="'+g+'"]');c.find('[data-status]').on('click',function(e){e.preventDefault();var b=$(this),status=b.attr('data-status');d['iconPrefix']=mainCheckbox.attr('data-icon-prefix');if(status==='m_-inverse'){$(f.itemsSelector).filter('['+f.nameAttr+'="'+g+'"]').each(function(){var a=$(this);k(a,d)})}else{$(f.itemsSelector).filter('['+f.nameAttr+'="'+g+'"]').each(function(){var a=$(this),statuses=a.attr('data-status').split('|'),isValid=false;for(var i=0;i<statuses.length;i++){if(status==statuses[i]){l(a,d);isValid=true}}if(!isValid){m(a,d)}})}mainCheckbox.trigger('selection-change.selection');c.trigger('selection-change.selection')})};var o=function(f,g,h){var i=f.attr(h.nameAttr);g['iconPrefix']=f.attr('data-icon-prefix');var j=function(c){var d=false,all=true,no=0,count=0,values=mesour.selection.getValues(i);$.each(values,function(a,b){if(b){d=true}else{no++;all=false}count++});var e=count===no;if(c){if(f.hasClass('btn-default')||f.hasClass("btn-indeterminate")){$(h.itemsSelector).filter('['+h.nameAttr+'="'+i+'"]').each(function(){var a=$(this);l(a,g)});all=true}else{$(h.itemsSelector).filter('['+h.nameAttr+'="'+i+'"]').each(function(){var a=$(this);m(a,g)});all=false;d=false}}f.removeClass('btn-indeterminate');if(all){l(f,g)}else if(d&&!e){l(f,g,mesour.selection.ICON_MINUS);f.addClass('btn-indeterminate')}else{m(f,g)}f.trigger('change.selection')};f.on({'click.selection':function(e){e.preventDefault();e.stopPropagation();j(true)},'selection-change.selection':function(){j()}})};var p=function(a,b,c){var d=a.attr(c.nameAttr),mainCheckbox=$(c.mainSelector).filter('['+c.nameAttr+'="'+d+'"]');b['iconPrefix']=mainCheckbox.attr('data-icon-prefix');var e=function(){k(a,b);mainCheckbox.trigger('selection-change.selection');a.trigger('change.selection')};a.on({'click.selection':function(){e()},'selection-change.selection':function(){e()}})};var q=function(d){this.ICON_MINUS='minus';this.ICON_CHECKED='check';var e={};e[this.ICON_MINUS]='minus';e[this.ICON_CHECKED]='check';this.getValues=function(b){var c={};$(d.itemsSelector).filter('['+d.nameAttr+'="'+b+'"]').each(function(){var a=$(this);c[a.attr(d.idAttr)]=a.hasClass(d.item.activeClass)});return c};this.getItems=function(a){return $(d.itemsSelector).filter('['+d.nameAttr+'="'+a+'"]')};this.getMainCheckbox=function(a){return $(d.mainSelector).filter('['+d.nameAttr+'="'+a+'"]')};this.setIcon=function(a,b){e[a]=b};this.getIcon=function(a){return e[a]};this.create=function(){$(d.itemsSelector).each(function(){var a=$(this),instance=a.data('_m-selection');if(!instance){instance=new p(a,d.item,d)}});$(d.mainSelector).each(function(){var a=$(this),instance=a.data('_m-selection');if(!instance){instance=new o(a,d.item,d)}});$(d.dropDownSelector).each(function(){var a=$(this),instance=a.data('_m-selection');if(!instance){instance=new n(a,d.item,d)}})}};mesour.core.createWidget('selection',new q({'itemsSelector':'.mesour-select-checkbox','mainSelector':'.mesour-main-checkbox','dropDownSelector':'.selection-dropdown','nameAttr':'data-name','idAttr':'data-id','statusAttr':'data-status','item':{'activeClass':'btn-warning','inactiveClass':'btn-default'}}));mesour.on.live('grid-selection',mesour.selection.create)})(jQuery);